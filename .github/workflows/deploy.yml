name: Deploy to AWS Lightsail (Bare Metal)

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  LIGHTSAIL_HOST: 75.101.190.200
  SITE_NAME: haley.localhost

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/lightsail.pem
          chmod 600 ~/.ssh/lightsail.pem
          ssh-keyscan -H ${{ env.LIGHTSAIL_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy
        run: |
          ssh -i ~/.ssh/lightsail.pem ubuntu@${{ env.LIGHTSAIL_HOST }} << 'DEPLOY'
            sudo -u frappe bash << 'FRAPPE'
              set -e
              cd /home/frappe/repos/haley

              echo "=== Pulling latest code ==="
              git pull origin main

              cd /home/frappe/frappe-bench
              export PATH=$PATH:/home/frappe/.local/bin

              echo "=== Reinstalling app ==="
              ./env/bin/pip install -q -e apps/enhanced_kanban_view

              echo "=== Running migrations ==="
              bench --site haley.localhost migrate --skip-failing

              echo "=== Building assets ==="
              bench build --app enhanced_kanban_view

              echo "=== Clearing cache ==="
              bench --site haley.localhost clear-cache
            FRAPPE

            echo "=== Restarting services ==="
            sudo supervisorctl restart all

            echo "=== Deployment complete! ==="
          DEPLOY

      - name: Health check
        run: |
          sleep 10
          curl -f http://${{ env.LIGHTSAIL_HOST }} || echo "Site may still be starting..."
